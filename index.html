<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Billio - Budget Buddy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Favicon: Cat face emoji -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê±</text></svg>">
  
<style>
* { box-sizing:border-box; font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif; }
body { margin:0; padding:2rem 1rem 6rem; background:#f2f3f5; color:#111; }
.container { max-width:420px; margin:auto; display:none; }

/* HERO */
.hero { background:white; border-radius:20px; padding:2rem; text-align:center; margin-bottom:1.5rem; }
.hero-amount { font-size:3rem; font-weight:700; }
.hero-amount.negative { color:#c0392b; }
.hero-label { font-size:0.9rem; color:#666; }
.hero-sub { font-size:0.8rem; color:#888; margin-top:0.4rem; }

/* CONTEXT */
.context { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1.5rem; }
.context-card { background:white; border-radius:16px; padding:1rem; text-align:center; }
.context-value { font-size:1.25rem; font-weight:600; }
.context-label { font-size:0.8rem; color:#666; }

/* BILLS */
.bills { background:white; border-radius:20px; padding:1.5rem; margin-bottom:1rem; }
.bills-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.bills-header h2 { margin:0; font-size:1.1rem; }
.toggle { font-size:0.8rem; color:#666; }
.bill-list { margin-top:1rem; display:none; }

/* BILL ITEM */
.bill-wrapper { position: relative; overflow: hidden; }
.bill { padding:0.75rem 0; border-bottom:1px solid #eee; background:white; transition: transform 0.3s ease; display:flex; flex-direction:column; }
.bill:last-child { border-bottom:none; }
.bill-main { display:flex; justify-content:space-between; align-items:center; width:100%; }
.bill-actions {
  opacity: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  position: relative;
  top: 0;
}
.bill:hover .bill-actions { opacity:1; }
.icon-btn { background:none; border:none; cursor:pointer; padding:0; display:flex; position: relative; top:-2px; left:4px; align-items:center; justify-content:center; }
.icon-btn svg { width:20px; height:20px; fill:#111; transition: fill 0.2s; }
.icon-btn:hover svg { fill:#555; }
.icon-row { display: flex; align-items: center; gap: 8px; }
.chip { padding:2px 6px; border-radius:12px; font-size:0.65rem;}
.frequencychip { background:#e6e7eb; padding:2px 6px; border-radius:4px; font-size:0.8rem; margin-right:3px; }
.bill-divider {
  height: 1px;
  background: #ccc;
  margin: 0.6rem 0;
  width: 100%;
  position: relative;
}
.bill-divider div {
  position: absolute;
  top: -0.75rem;
  left: 50%;
  transform: translateX(-50%);
  background: #f2f3f5;
  padding: 0 4px;
}
  
/* CONTROLS */
.controls { position:fixed; bottom:0; left:0; right:0; background:white; padding:0.75rem; display:grid; grid-template-columns:repeat(3,1fr); gap:0.5rem; }
.controls button { padding:0.6rem; border-radius:10px; border:none; font-size:0.75rem; cursor:pointer; }
.primary { background:#111; color:white; }
.secondary { background:#e6e7eb; }
.logout-btn { background: none; border: none; color: #888; font-size: 0.75rem; }

/* MODALS */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  padding: 1rem;
  z-index: 1000;
}

.modal {
  background: white;
  border-radius: 20px 20px 20px 20px;
  width: 100%;
  max-width: 420px;
  padding: 2rem;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.modal input,
.modal select {
  width: 100%;
  padding: 0.5rem;
  margin: 0.5rem 0;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-sizing: border-box;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.close-btn {
  cursor: pointer;
  font-weight: bold;
  font-size: 1.2rem;
}

.modal button {
  margin-top: 1rem;
  padding: 0.6rem;
  border: none;
  border-radius: 10px;
  background: #111;
  color: white;
  width: 100%;
  cursor: pointer;
}

.date-field {
  width: 100%;
  overflow: hidden;
  border-radius: 8px;
}

.date-field input[type="date"] {
  width: 100%;
  max-width: 100%;  
  min-height: 35px;
  display: block;
  box-sizing: border-box;
  -webkit-appearance: none;
  appearance: none;
}
  
.input-label {
  font-size: 0.75rem;
  color: #666;
  margin-top: 0.5rem;
  display: block;
}

@media (max-width: 768px) {
  .modal input,
  .modal select,
  .modal textarea,
  .modal button {
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
  }
}

#loginModal input { margin:0.5rem 0; }
#loginModal button { background:#111; color:white; margin-top:1rem; }

#authToggleText,
#authToggleLink
  { font-size: 0.8rem; }

.mobile-only { display: none; }
@media (max-width: 768px) {
  .bill-actions {
    opacity: 1 !important;
    pointer-events: auto;
  }
  .mobile-only { display: block; }
}

/* MOBILE FIXES */
@media (max-width: 768px) {
  body {
    padding: 1rem 0.5rem 6rem; /* reduce padding on mobile */
  }

  .container {
    width: 100%;
    margin: 0.5rem auto;
    padding: 0 0.5rem;
  }

  /* Make bill actions always visible and easier to tap */
  .bill-actions {
    opacity: 1 !important;
    pointer-events: auto;
    flex-direction: row;
    gap: 0.5rem;
  }

  /* Ensure bill amounts and buttons stay in the same row as the bill name */
  .bill-main {
    flex-direction: row;       /* row layout */
    align-items: center;       /* vertically center items */
    justify-content: space-between;
    width: 100%;
    gap: 0.5rem;
  }

  /* Optional: prevent bill name from wrapping */
  .bill-main > div:first-child {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex-shrink: 1;
  }

  /* Remove previous last-child margin adjustments */
  .bill-main > div:last-child {
    margin-top: 0;
    margin-left: 0;
  }

  /* Make edit/delete buttons easier for thumb access */
  .icon-row {
    margin: 0;
    display: flex;
    gap: 0.5rem;
  }

  /* Modal input scaling */
  .modal input,
  .modal select,
  .modal textarea,
  .modal button {
    font-size: 16px;
  }
  
  /* Date picker fixes */
  .date-field input[type="date"] {
    min-height: 40px;
    font-size: 16px;
    padding: 0.4rem;
  }

  /* Mobile-only labels */
  .mobile-only {
    display: block !important;
    margin-top: 0.25rem;
    font-size: 0.75rem;
    color: #666;
  }

  /* Controls spacing */
  .controls button {
    font-size: 0.85rem;
    padding: 0.7rem 0.5rem;
  }

  /* Hero section scaling */
  .hero-amount {
    font-size: 2.2rem;
  }

  .hero-label,
  .hero-sub {
    font-size: 0.75rem;
  }

  /* Context cards */
  .context-card {
    padding: 0.8rem;
  }

  .context-value {
    font-size: 1.1rem;
  }
}

/* Billio app name above welcome text */
#loginModal .modal .app-name {
  font-size: 1rem;
  font-weight: 600;
  color: #111;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  font-family: 'Helvetica Neue', sans-serif;
}

#loginModal .modal-header {
  display: flex;
  align-items: center;
  gap: 0.5rem; /* space between Billio and Welcome */
}
  
#loginModal #authTitle {
  font-weight: 600;
}
  
.welcome-text {
  opacity: 0.6; /* lower opacity for the text */
  font-weight: 400; /* optional, to reduce weight */
}

.emoji {
  opacity: 1; /* keep emojis fully opaque */
}

</style>
</head>
<body>

<!-- DASHBOARD -->
<div class="container" id="dashboard">
  <section class="hero">
    <div class="hero-amount" id="spendingLeft">$0.00</div>
    <div class="hero-label" id="heroIncomeLabel">Spending Money Left</div>
    <div class="hero-sub" id="heroSubText">This period</div>
  </section>

  <section class="context">
    <div class="context-card">
      <div class="context-value" id="incomeValue">$0.00</div>
      <div class="context-label" id="incomeLabel">Income</div>
    </div>
    <div class="context-card">
      <div class="context-value" id="billsValue">$0.00</div>
      <div class="context-label">Total Bills</div>
    </div>
  </section>

  <section class="bills">
    <div class="bills-header" onclick="toggleBills()">
      <h2>Bill Details</h2>
      <span class="toggle" id="toggleText">Show</span>
    </div>
    <div class="bill-list" id="billList"></div>
  </section>
</div>

<section class="controls">
  <button class="secondary" onclick="showModal('incomeModal')">Income</button>
  <button class="secondary" id="addBillBtn" onclick="showModal('billsModal')">Add Bill</button>
  <button class="logout-btn" onclick="logout()">Log Out</button>
</section>

<!-- MODALS -->
<div class="modal-overlay" id="incomeModal">
  <div class="modal">
    <div class="modal-header"><h3>Edit Income</h3><span class="close-btn" onclick="closeModal('incomeModal')">&times;</span></div>
    <input type="number" id="incomeAmount" placeholder="Income Amount">
    <select id="incomeFrequency">
      <option value="weekly">Weekly</option>
      <option value="biweekly">Biweekly</option>
      <option value="monthly">Monthly</option>
    </select>
    <label class="input-label mobile-only">Payday</label>
    <div class="date-field">
      <input type="date" id="nextPayday">
    </div>
    <button onclick="saveIncome()">Save</button>
  </div>
</div>

<div class="modal-overlay" id="billsModal">
  <div class="modal">
    <div class="modal-header"><h3>Manage Bills</h3><span class="close-btn" onclick="closeModal('billsModal')">&times;</span></div>
    <input type="text" id="newBillName" placeholder="Bill Name">
    <input type="number" id="newBillAmount" placeholder="Amount">
    <select id="newBillFrequency">
      <option value="weekly">Weekly</option>
      <option value="biweekly">Biweekly</option>
      <option value="monthly">Monthly</option>
    </select>
    <div class="date-field">
      <label class="input-label mobile-only">Due Date</label>
      <input type="date" id="newBillStart">
    </div>
    <button onclick="addBill()">Save</button>
  </div>
</div>

<!-- LOGIN MODAL: TOGGLE/SWITCH FORM -->
<div class="modal-overlay" id="loginModal">
  <div class="modal">
    <div class="modal-header app-header">
      <div class="app-name">Billio</div>
    </div>

    <h3 id="authTitle">
      <span class="welcome-text">Welcome</span> <span class="emoji">üëã</span>
    </h3>
   
    <input type="email" id="authEmail" placeholder="Email" />
    <input type="password" id="authPassword" placeholder="Password" />

    <!-- Forgot password -->
    <p id="forgotPasswordWrapper" style="text-align:center; margin-top:0.25rem; display:none; font-size:0.875rem;">
      <a href="#" id="forgotPasswordLink" onclick="forgotPassword(event)">Forgot Password?</a>
    </p>
    
    <!-- Inline error message -->
    <div id="authError" style="color:red; font-size:0.8rem; margin-top:0.25rem; display:none; text-align:center;"></div>

    <button id="authSubmitBtn" onclick="handleAuth()">Log In</button>

    <p style="text-align:center; margin-top:0.5rem;">
      <span id="authToggleText">Not registered? </span>
      <a href="#" id="authToggleLink" onclick="toggleAuthMode(event)">Register</a>
    </p>
  </div>
</div>

<!-- FIREBASE SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA0UCkq1LBiewo48_mDgFnd2zPs2BbSkfI",
  authDomain: "budget-calculator-af483.firebaseapp.com",
  projectId: "budget-calculator-af483",
  storageBucket: "budget-calculator-af483.firebasestorage.app",
  messagingSenderId: "560067714902",
  appId: "1:560067714902:web:b7801e12244f8cffb0c0f7"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let income = { amount: 0, frequency: "monthly", nextPayday: null };
let bills = [];
let billsVisible = false;
let editIndex = null;

// ==================== LOGIN/REGISTER TOGGLE ====================
let authMode = "login"; // "login" or "register"

function toggleAuthMode(e){
  e.preventDefault();
  authMode = authMode === "login" ? "register" : "login";
  
  const title = document.getElementById("authTitle");
  const submitBtn = document.getElementById("authSubmitBtn");
  const toggleText = document.getElementById("authToggleText");
  const toggleLink = document.getElementById("authToggleLink");
  const forgotWrapper = document.getElementById("forgotPasswordWrapper");
  const authError = document.getElementById("authError");

  // Clear any previous error
  authError.style.display = "none";
  authError.textContent = "";

  if(authMode === "login"){
    const currentEmoji = title.querySelector(".emoji")?.textContent || "üëã";
    title.innerHTML = `<span class="welcome-text">Welcome Back</span> <span class="emoji">${currentEmoji}</span>`;
    submitBtn.textContent = "Log In";
    toggleText.textContent = "Not registered? ";
    toggleLink.textContent = "Register";
    forgotWrapper.style.display = "block"; // show forgot password
  } else {
    title.innerHTML = `<span class="welcome-text">Create Account</span>`;
    submitBtn.textContent = "Register";
    toggleText.textContent = "Already have an account? ";
    toggleLink.textContent = "Log In";
    forgotWrapper.style.display = "none"; // hide forgot password
  }
}

// ==================== HANDLE LOGIN / REGISTER ====================
function handleAuth() {
  const email = document.getElementById("authEmail").value.trim();
  const password = document.getElementById("authPassword").value.trim();
  const authError = document.getElementById("authError");

  authError.style.display = "none";
  authError.textContent = "";

  if (!email || !password) {
    authError.textContent = "Please enter both email and password.";
    authError.style.display = "block";
    return;
  }

  if (authMode === "login") {
    auth.signInWithEmailAndPassword(email, password)
      .then(userCredential => {
        const user = userCredential.user;
        if (!user.emailVerified) {
          auth.signOut();
          authError.textContent = "Please verify your email before logging in. Check your inbox!";
          authError.style.display = "block";
        }
      })
      .catch(err => {
        authError.textContent = err.message;
        authError.style.display = "block";
      });
  } else {
    // Registration
    auth.createUserWithEmailAndPassword(email, password)
      .then(userCredential => {
        const user = userCredential.user;
        user.sendEmailVerification()
          .then(() => {
            authError.textContent = "Verification email sent! Please check your inbox before logging in.";
            authError.style.color = "green"; // optional: green for success
            authError.style.display = "block";
            // Switch to login screen
            if (authMode !== "login") toggleAuthMode({ preventDefault: () => {} });
          })
          .catch(err => {
            authError.textContent = "Failed to send verification email: " + err.message;
            authError.style.display = "block";
          });
      })
      .catch(err => {
        authError.textContent = err.message;
        authError.style.display = "block";
      });
  }
}

// ==================== INIT ON PAGE LOAD ====================
document.addEventListener("DOMContentLoaded", () => {
  const forgotWrapper = document.getElementById("forgotPasswordWrapper");
  // Show forgot password immediately if modal defaults to login
  forgotWrapper.style.display = authMode === "login" ? "block" : "none";
});

// ==================== EXISTING DASHBOARD LOGIC ====================
function logout(){ if(confirm("Log out of your account?")) auth.signOut(); }

auth.onAuthStateChanged(user => {
  const dashboard = document.getElementById("dashboard");
  const loginModal = document.getElementById("loginModal");
  const controls = document.querySelector(".controls"); // reference controls

  if(user){
    loginModal.style.display = "none";
    dashboard.style.display = "block";
    controls.style.display = "grid"; // show controls
    loadUserData(user.uid);
  } else {
    dashboard.style.display = "none";
    loginModal.style.display = "flex";
    controls.style.display = "none"; // hide controls when logged out
  }
});

function forgotPassword(e) {
  e.preventDefault();
  const email = document.getElementById("authEmail").value.trim();
  if (!email) return alert("Please enter your email to reset password.");

  auth.sendPasswordResetEmail(email)
    .then(() => {
      alert("Password reset email sent! Check your inbox.");
    })
    .catch(err => {
      alert(err.message);
    });
}

function saveUserData(){ db.collection("users").doc(auth.currentUser.uid).set({income, bills}); }
function loadUserData(uid){
  db.collection("users").doc(uid).onSnapshot(doc=>{
    const data = doc.data();
    if(data){ income = data.income||income; bills = data.bills||bills; recalc(); }
  });
}

function toggleBills(){
  if(!income.nextPayday){ alert("Please input your income first."); return; }
  billsVisible = !billsVisible;
  document.getElementById("billList").style.display = billsVisible ? "block" : "none";
  document.getElementById("toggleText").textContent = billsVisible ? "Hide" : "Show";
}

function showModal(id){
  document.getElementById(id).style.display="flex";
  if(id==="billsModal" && editIndex===null){
    document.getElementById("newBillName").value="";
    document.getElementById("newBillAmount").value="";
    document.getElementById("newBillStart").value="";
  }
}
function closeModal(id){ if(id!=="loginModal") {document.getElementById(id).style.display="none"; editIndex=null;} }

function saveIncome() {
  const amount = parseFloat(document.getElementById("incomeAmount").value);
  const frequency = document.getElementById("incomeFrequency").value;
  const nextPayday = document.getElementById("nextPayday").value;

  if (isNaN(amount) || amount <= 0) { alert("Please enter a valid income amount."); return; }
  if (!nextPayday) { alert("Please select your next payday."); return; }

  income = { amount, frequency, nextPayday };
  saveUserData();
  closeModal("incomeModal");
  recalc();
}

function addBill() {
  const name = document.getElementById("newBillName").value.trim();
  const amount = parseFloat(document.getElementById("newBillAmount").value);
  const frequency = document.getElementById("newBillFrequency").value;
  const startDate = document.getElementById("newBillStart").value;

  if (!name) { alert("Please enter a name for your bill."); return; }
  if (isNaN(amount) || amount <= 0) { alert("Please enter a valid amount for the bill."); return; }
  if (!startDate) { alert("Please select a start date for the bill."); return; }

  if(editIndex!==null){
    bills[editIndex]={name, amount, frequency, date:startDate};
    editIndex=null;
  } else {
    bills.push({name, amount, frequency, date:startDate});
  }

  saveUserData();
  closeModal("billsModal");
  recalc();
}


// ==================== BILL RENDER ====================
function renderBills() {
  if (!income.nextPayday) return;

  const [y, m, d] = income.nextPayday.split("-");
  const start = new Date(y, m - 1, d);
  const end = new Date(start);
  if (income.frequency === "weekly") end.setDate(start.getDate() + 6);
  if (income.frequency === "biweekly") end.setDate(start.getDate() + 13);
  if (income.frequency === "monthly") end.setMonth(start.getMonth() + 1, 0);

  const list = document.getElementById("billList");

  updateTotals(start, end);
  list.innerHTML = "";

  if (bills.length === 0) {
    list.innerHTML = `<div style="text-align:center;color:#888; font-size:0.9rem;">No bills yet</div>`;
    return;
  }

  let inPeriod = [], outPeriod = [];

  bills.forEach((b, index) => {
    const [y1, m1, d1] = b.date.split("-");
    let current = new Date(y1, m1 - 1, d1);
    const step = { weekly: 7, biweekly: 14, monthly: 1 }[b.frequency];
    let occursInPeriod = false;

    if (b.frequency === "monthly") {
      occursInPeriod = current >= start && current <= end;
    } else {
      while (current <= end) {
        if (current >= start) { occursInPeriod = true; break; }
        current.setDate(current.getDate() + step);
      }
    }

    const billData = { bill: b, originalIndex: index }; // store original index
    if (occursInPeriod) inPeriod.push(billData);
    else outPeriod.push(billData);
  });

  // Sort only in-period bills
  inPeriod.sort((a, b) => getNextBillDate(a.bill, start) - getNextBillDate(b.bill, start));
  const sortedBills = [...inPeriod, ...outPeriod];

  // Render all bills
  sortedBills.forEach((bData, i) => {
    const b = bData.bill;
    const originalIndex = bData.originalIndex;

    const billEl = document.createElement("div");
    billEl.className = "bill-wrapper";

    const inner = document.createElement("div");
    inner.className = "bill";

    const [y1, m1, d1] = b.date.split("-");
    let current = new Date(y1, m1 - 1, d1);
    const step = { weekly: 7, biweekly: 14, monthly: 1 }[b.frequency];
    const occurrences = [];
    if (b.frequency === "monthly") {
      if (current >= start && current <= end) occurrences.push(new Date(current));
    } else {
      while (current <= end) {
        if (current >= start) occurrences.push(new Date(current));
        current.setDate(current.getDate() + step);
      }
    }

    const dateChips = occurrences
      .map(dt => `<span class="chip">${dt.toLocaleDateString("en-US",{month:"short", day:"numeric"})}</span>`)
      .join("‚Ä¢");

    inner.innerHTML = `
      <div class="bill-main" style="display:flex; justify-content:space-between; align-items:flex-start; width:100%;">
        <div style="display:flex; flex-direction:column;">
          <div style="display:flex; align-items:center; gap:0.5rem;">
            <span style="font-weight:500; margin-bottom:6px;">${b.name}</span>
          </div>
          <div><span class="frequencychip">${b.frequency.charAt(0).toUpperCase()+b.frequency.slice(1)}</span></div>
          <div class="bill-meta" style="margin-top:4px; margin-left:-5px">${dateChips}</div>
        </div>
        <div style="margin-left:auto; margin-right:0.5rem; display:flex; align-items:center;">
          <span>$${b.amount.toFixed(2)}</span>
        </div>
        <div class="bill-actions" style="display:flex; gap:0.5rem; align-items:center;">
          <div class="icon-row">
            <button class="icon-btn" onclick="editBill(${originalIndex})">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                <path d="M3 21v-3l12-12 3 3-12 12H3z"/>
              </svg>
            </button>
            <button class="icon-btn" onclick="deleteBill(${originalIndex})">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                <path d="M18.364 5.636a1 1 0 0 0-1.414 0L12 10.586 7.05 5.636a1 1 0 0 0-1.414 1.414L10.586 12l-4.95 4.95a1 1 0 1 0 1.414 1.414L12 13.414l4.95 4.95a1 1 0 0 0 1.414-1.414L13.414 12l4.95-4.95a1 1 0 0 0 0-1.414z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    `;

    inner.style.opacity = occurrences.length ? 1 : 0.5;
    billEl.appendChild(inner);
    list.appendChild(billEl);

    // Divider logic
    if (i < inPeriod.length - 1) {
      const divider = document.createElement("div");
      divider.className = "bill-divider";
      divider.innerHTML = `<div></div>`;
      list.appendChild(divider);
    }
    if (i === inPeriod.length - 1 && outPeriod.length > 0) {
      const outDivider = document.createElement("div");
      outDivider.className = "bill-divider";
      outDivider.innerHTML = `<div style="text-align:center;font-size:0.75rem;color:#888; margin-bottom:4px;"></div>`;
      list.appendChild(outDivider);
    }
  });
}

// No changes needed for these functions
function getNextBillDate(bill, ref){
  const [y,m,d] = bill.date.split("-");
  let current = new Date(y,m-1,d);
  const step = {weekly:7,biweekly:14,monthly:1}[bill.frequency];
  if(bill.frequency==="monthly"){ 
    return current>=ref ? current : new Date(current.getFullYear(), current.getMonth()+1, current.getDate()); 
  } else { 
    while(current<ref) current.setDate(current.getDate()+step); 
    return current; 
  }
}

function updateTotals(start,end){
  let totalBills=0;
  bills.forEach(b=>{
    const [y2,m2,d2]=b.date.split("-");
    let c=new Date(y2,m2-1,d2); 
    const step={weekly:7,biweekly:14,monthly:1}[b.frequency]; 
    let count=0;
    if(b.frequency==="monthly"){ if(c>=start && c<=end) count=1; } 
    else { while(c<=end){ if(c>=start) count++; c.setDate(c.getDate()+step); } }
    totalBills += count*b.amount; 
  });

  const spending = income.amount-totalBills;
  document.getElementById("spendingLeft").textContent=`$${spending.toFixed(2)}`;
  document.getElementById("spendingLeft").className="hero-amount"+(spending<0?" negative":"");
  document.getElementById("incomeValue").textContent=`$${income.amount.toFixed(2)}`;
  document.getElementById("billsValue").textContent=`$${totalBills.toFixed(2)}`;
}

// Helper: get next occurrence of a bill relative to a reference date
function getNextBillDate(bill, ref){
  const [y,m,d] = bill.date.split("-");
  let current = new Date(y,m-1,d);
  const step = {weekly:7,biweekly:14,monthly:1}[bill.frequency];
  if(bill.frequency==="monthly"){ return current>=ref ? current : new Date(current.getFullYear(), current.getMonth()+1, current.getDate()); }
  else { while(current<ref) current.setDate(current.getDate()+step); return current; }
}

// Totals calculation
function updateTotals(start,end){
  let totalBills=0;
  bills.forEach(b=>{
    const [y2,m2,d2]=b.date.split("-");
    let c=new Date(y2,m2-1,d2); 
    const step={weekly:7,biweekly:14,monthly:1}[b.frequency]; 
    let count=0;
    if(b.frequency==="monthly"){ if(c>=start && c<=end) count=1; } 
    else { while(c<=end){ if(c>=start) count++; c.setDate(c.getDate()+step); } }
    totalBills += count*b.amount; 
  });

  const spending = income.amount-totalBills;
  document.getElementById("spendingLeft").textContent=`$${spending.toFixed(2)}`;
  document.getElementById("spendingLeft").className="hero-amount"+(spending<0?" negative":"");
  document.getElementById("incomeValue").textContent=`$${income.amount.toFixed(2)}`;
  document.getElementById("billsValue").textContent=`$${totalBills.toFixed(2)}`;
}

function editBill(i){ editIndex=i; showModal("billsModal"); const b=bills[i]; document.getElementById("newBillName").value=b.name; document.getElementById("newBillAmount").value=b.amount; document.getElementById("newBillFrequency").value=b.frequency; document.getElementById("newBillStart").value=b.date; }
function deleteBill(i){ if(confirm(`Delete bill "${bills[i].name}"?`)){ bills.splice(i,1); saveUserData(); recalc(); } }

function recalc(){ document.getElementById("heroIncomeLabel").textContent="Spending Money Left"; const heroSub = document.getElementById("heroSubText");
heroSub.textContent = income.frequency === "weekly" ? "This week" :
                      income.frequency === "biweekly" ? "This pay period" :
                      "This month";
renderBills(); }
  
// ====== WELCOME TITLE ANIMATION ======
const quirkyAnimals = [
  "ü¶Ñ‚ú®", "üêâüîÆ", "üê∏üíö", "ü¶äüî•", "ü¶©üå∏",
  "üêßüé©", "üêπüõ∑", "ü¶•üòé", "üê±üçï", "üê∞üíå",
  "ü¶îüéµ", "ü¶¶üéæ", "üê¢üí§", "üêëüé§", "ü¶Äüíé",
  "üê¨üåä", "ü¶íüéà", "üêá‚ú®", "ü¶®üß™", "üêíüé®",
  "ü¶¶üéÅ", "üêùüçØ", "ü¶òüèÄ", "üêÜ‚ö°", "ü¶âüìö",
  "ü¶úüß©", "üêãüé∑", "ü¶ûüçã", "üêäü™µ", "ü¶•üéß",
  "ü¶îüñåÔ∏è", "ü¶¶üõÅ", "üêìü•Å", "ü¶áüåô", "ü¶â‚òï",
  "üê†üåà", "üêåüçÑ", "üêøÔ∏èüí®", "ü¶ÄüèñÔ∏è", "üêµüéâ",
  "ü¶ëüõ∏", "üê∏üéà", "üêßüï∫", "üê¢üé©", "ü¶ñüî•",
  "ü¶âüé§", "üêùüéµ", "ü¶îü™ï", "üêäüéØ", "ü¶ìüç¶",
  "üêçüé©", "ü¶ûüéÅ"
];

function updateTitleRandomly() {
  const emojiEl = document.querySelector("#authTitle .emoji");
  if (!emojiEl) return; // Skip if emoji span doesn‚Äôt exist

  const randomIndex = Math.floor(Math.random() * quirkyAnimals.length);
  emojiEl.textContent = quirkyAnimals[randomIndex];
}

// Update every 3 seconds
setInterval(updateTitleRandomly, 3000);

</script>
</body>
</html>
