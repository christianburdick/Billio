<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Billio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Favicon: Cat face emoji -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê±</text></svg>">
  
<style>
* { box-sizing:border-box; font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif; }
body { margin:0; padding:2rem 1rem 6rem; background:#f2f3f5; color:#111; }
.container { max-width:420px; margin:auto; display:none; }

/* HERO */
.hero { background:white; border-radius:20px; padding:2rem; text-align:center; margin-bottom:1.5rem; }
.hero-amount { font-size:3rem; font-weight:700; }
.hero-amount.negative { color:#c0392b; }
.hero-label { font-size:0.9rem; color:#666; }
.hero-sub { font-size:0.8rem; color:#888; margin-top:0.4rem; }

/* CONTEXT */
.context { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1.5rem; }
.context-card { background:white; border-radius:16px; padding:1rem; text-align:center; }
.context-value { font-size:1.25rem; font-weight:600; }
.context-label { font-size:0.8rem; color:#666; }

/* BILLS */
.bills { background:white; border-radius:20px; padding:1.5rem; margin-bottom:1rem; overflow: hidden; }
.bills-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
.bills-header h2 { margin:0; font-size:1.1rem; }
.toggle-btn {
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.toggle-icon { width: 20px; height: 20px; stroke: #666; fill: none; transition: transform 0.2s ease; }
.toggle-btn.is-open .toggle-icon { transform: rotate(180deg); }
.bill-list { margin-top:1rem; display:none; }

/* BILL ITEM */
.bill-wrapper { position: relative; overflow: hidden; z-index: 1; }
.bill-list.dragging .bill-wrapper { transition: transform 0.32s cubic-bezier(0.22, 1, 0.36, 1); }
.bill-list.reorder-mode .bill-wrapper { transition: transform 0.32s cubic-bezier(0.22, 1, 0.36, 1); }
.bill { padding:0.75rem 0; border-bottom:1px solid #eee; background:white; transition: transform 0.3s ease; display:flex; flex-direction:column; }
.bill:last-child { border-bottom:none; }
.bill-main { display:flex; justify-content:space-between; align-items:center; width:100%; }
.bill-row { display:flex; justify-content:space-between; align-items:flex-start; width:100%; gap:0.5rem; user-select:none; -webkit-user-select:none; touch-action: pan-y; cursor:default; }
.bill-list.dragging .bill-row,
.bill-wrapper.dragging .bill-row {
  cursor: grabbing;
}
body.drag-cursor,
body.drag-cursor * {
  cursor: grabbing !important;
}
.bill-content { display:flex; flex:1; flex-direction:column; gap:0.4rem; min-width:0; }
.bill-details { display:none; flex-wrap:wrap; align-items:center; gap:0.4rem; row-gap:0.55rem; margin-top:0rem; width:100%; justify-content:space-between; }
.bill-wrapper[data-pending="true"] .bill-details {
  gap: 0.4rem;
  justify-content: flex-start;
}
.bill-wrapper[data-pending="true"] .bill-details > * {
  margin: 0;
}
.occurrence-chips,
.occurrence-empty {
  margin-top:0;
}
.bill-details.show { display:flex; }
.bill-right { display:flex; align-items:flex-end; gap:0.4rem; white-space:nowrap; flex-shrink:0; margin-left:auto; margin-right:0.25rem; }
.bill-amount { font-weight:400; font-size:1rem; color:#111; }
.bill-amount-btn { background:none; border:none; padding:0; font-weight:400; cursor:pointer; font-size:1rem; color:#111; }
.bill-name-btn {
  background:none;
  border:none;
  padding:0;
  text-align:left;
  font-weight:500;
  font-size:1rem;
  cursor:pointer;
  color:#111;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.bill-name-input {
  width:auto;
  min-width: 6ch;
  border:none;
  background:transparent;
  padding:0;
  font-size:1rem;
  font-weight:500;
  color:#111;
  display:inline-block;
  align-self:flex-start;
  max-width:100%;
}
.bill-name-input:focus {
  outline:none;
}
.inline-editor {
  position: fixed;
  z-index: 1200;
  display: none;
  padding: 0.6rem;
  background: white;
  border: 1px solid #e5e5ea;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.12);
}
.inline-editor input,
.inline-editor select {
  width: 180px;
  padding: 0.4rem 0.5rem;
  border-radius: 8px;
  border: 1px solid #ddd;
}
.bill-actions {
  opacity: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  position: relative;
  top: 0;
}
.bill-actions.show { opacity: 1; }
.icon-btn { background:none; border:none; cursor:pointer; padding:0; display:flex; position: relative; top:1px; left:4px; align-items:center; justify-content:center; }
.icon-btn svg { width:20px; height:20px; fill:#111; transition: fill 0.2s; }
.icon-row { display: flex; align-items: center; gap: 8px; }
.chip {
  padding:2px 6px;
  border-radius:12px;
  font-size:0.65rem;
  font-weight:400;
  color:#3c3c3c;
  background:transparent;
  border:none;
}
.chip-rect,
.chip-btn.chip-rect {
  border-radius:4px;
  background:#e6e7eb;
  font-size:0.8rem;
  color:#222;
  border:none;
  margin-right:0;
  margin-bottom:0rem;
}
.chip-btn {
  background: transparent;
  border: none;
  color:#3c3c3c;
  cursor: pointer;
}
.bill-wrapper[data-pending="true"] .chip-btn[data-edit="date"] {
  border: 1px solid #d7d7dd;
  border-radius: 12px;
  font-size: 0.8rem;
}
.occurrence-chips { display:flex; flex-wrap:wrap; gap:0.15rem; width:100%; margin-top:0; }
.occurrence-chips .chip { font-size:0.65rem; padding:2px 6px; }
.chip-occurrence {
  background:transparent;
  border:1px solid #d7d7dd;
  color:#3c3c3c;
  cursor: pointer;
  border-radius:12px;
}
.chip-occurrence:hover { color:#2f2f35; }
.occurrence-empty { font-size:0.7rem; color:#999; margin-top:0; width:100%; }
.frequencychip { background:#e6e7eb; padding:2px 6px; border-radius:4px; font-size:0.8rem; margin-right:3px; }
.bill-divider {
  height: 1px;
  background: #ccc;
  margin: 0.6rem 0;
  width: 100%;
  position: relative;
}
.bill-divider div {
  position: absolute;
  top: -0.75rem;
  left: 50%;
  transform: translateX(-50%);
  background: #f2f3f5;
  padding: 0 4px;
}
  
/* CONTROLS */
.controls {
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  margin:0 auto;
  width:min(420px, 100%);
  background:rgba(255,255,255,0.92);
  backdrop-filter: blur(12px);
  padding:0.9rem;
  padding-bottom:calc(0.9rem + env(safe-area-inset-bottom));
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:0.6rem;
  border-top:none;
  border-radius:18px 18px 0 0;
  box-shadow:none;
  z-index:900;
}
.controls button {
  padding:0.6rem;
  border-radius:10px;
  border:none;
  font-size:0.75rem;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0.4rem;
  background:#f2f2f7;
  color:#111;
}
.controls button svg { width:20px; height:20px; }
.controls .income-icon { width:26px; height:26px; }
.primary { background:#111; color:white; }
.secondary { background:#f2f2f7; }
.logout-btn { background: none !important; border: none; color:#111; }

/* MODALS */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  padding: 1rem;
  z-index: 1000;
}

.modal {
  background: white;
  border-radius: 20px 20px 20px 20px;
  width: 100%;
  max-width: 420px;
  padding: 2rem;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}

.modal input,
.modal select {
  width: 100%;
  padding: 0.5rem;
  margin: 0.5rem 0;
  border-radius: 8px;
  border: 1px solid #ddd;
  box-sizing: border-box;
}
/* Hide number input spinners */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type="number"] {
  -moz-appearance: textfield;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.close-btn {
  cursor: pointer;
  font-weight: bold;
  font-size: 1.2rem;
}

.modal button {
  margin-top: 1rem;
  padding: 0.6rem;
  border: none;
  border-radius: 10px;
  background: #111;
  color: white;
  width: 100%;
  cursor: pointer;
}

/* INCOME SHEET */
#incomeModal{
  align-items:flex-end;
  justify-content:flex-end;
  padding:0;
  background:rgba(0,0,0,0.25);
}

#incomeModal .sheet{
  background:#fff;
  width:min(420px, 100%);
  border-radius:20px 20px 0 0;
  padding:1.5rem;
  padding-bottom:calc(1.5rem + env(safe-area-inset-bottom));
  box-shadow:0 10px 30px rgba(0,0,0,0.25);
  max-height:70vh;
  min-height:50vh;
  overflow-y:auto;
  margin:0 auto;
}

#incomeModal .sheet-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:0.5rem;
}

#incomeModal .sheet-row{
  display:grid;
  grid-template-columns:1fr 1.2fr;
  gap:0.75rem;
  align-items:center;
}

#incomeModal .sheet-label{
  font-size:0.85rem;
  color:#222;
}

/* ‚úÖ KEY: prevent grid children from "shrink-to-fit" weirdness on iOS */
#incomeModal .sheet-row > *{
  min-width:0;
}

/* ‚úÖ Unified input styling (text/select/date all match) */
#incomeModal .sheet input,
#incomeModal .sheet select{
  width:100%;
  min-width:0;              /* override the old 220px so it aligns in grid */
  max-width:100%;
  padding:0.5rem;
  height:40px;              /* consistent height across controls */
  line-height:1.2;
  margin:0;
  border-radius:8px;
  border:1px solid #ddd;
  box-sizing:border-box;
  background:#fff;
  color:#111;
  -webkit-text-fill-color:#111; /* iOS text color */
  -webkit-appearance:none;
  appearance:none;
  justify-self:stretch;     /* make it fill its grid column */
}

/* ‚úÖ iOS date input gets extra special handling */
#incomeModal .sheet input[type="date"]{
  text-align:left;
}

/* dividers + error + button */
#incomeModal .sheet-divider{
  height:1px;
  background:#e5e5ea;
  margin:0.75rem 0;
}

#incomeModal .inline-error{
  margin-top:0.75rem;
  font-size:0.8rem;
  color:#c62828;
  min-height:1em;
}

#incomeModal .sheet button{
  width:100%;
  background:#111;
  color:#fff;
  border-radius:12px;
  padding:0.7rem;
  margin-top:1rem;
  border:none;
}

/* If you're using a wrapper like .date-field elsewhere, keep it consistent */
.date-field{
  width:100%;
  overflow:hidden;
  border-radius:8px;
}

.date-field input[type="date"]{
  width:100%;
  max-width:100%;
  min-height:40px;          /* match height */
  padding:0.5rem;           /* match padding */
  margin:0;
  display:block;
  border-radius:8px;
  border:1px solid #ddd;
  box-sizing:border-box;
  background:#fff;
  color:#111;
  -webkit-text-fill-color:#111;
  -webkit-appearance:none;
  appearance:none;
}

/* New bill date pill */
#billsModal .pill-date {
  width: auto;
  min-height: unset;
  padding: 2px 6px;
  border: 1px solid #d7d7dd !important;
  box-shadow: inset 0 0 0 1px #d7d7dd;
  border-radius: 12px;
  background: transparent;
  color: #3c3c3c;
  font-size: 0.65rem;
  font-weight: 400;
  cursor: pointer;
  -webkit-appearance: none;
  appearance: none;
}
  
.input-label {
  font-size: 0.75rem;
  color: #666;
  margin-top: 0.5rem;
  display: block;
}

#loginModal input { margin:0.5rem 0; }
#loginModal button { background:#111; color:white; margin-top:1rem; }

#loginModal .modal {
  padding: 1.5rem;
  background: #fff;
  border-radius: 20px;
  max-width: 400px;
  align-items: stretch;
  box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

#authToggleText,
#authToggleLink
  { font-size: 0.8rem; }

.forgot-link {
  letter-spacing: 0.02em;
  text-decoration: none;
  color: #111;
  border-bottom: 1px solid rgba(0,0,0,0.5);
  padding-bottom: 2px;
  font-size: 0.78rem;
}

.mobile-only { display: none; }


@media (max-width: 768px) {
  .bill-name-input,
  .bill-amount-btn,
  .inline-editor input,
  .inline-editor select,
  #newBillAmount,
  #newBillName {
    font-size: 16px !important;
  }
}

.bill-wrapper.no-due,
.bill-wrapper.no-due .bill,
.bill-wrapper.no-due .bill-row,
.bill-wrapper.no-due .bill-content,
.bill-wrapper.no-due .bill-right {
  opacity: 0.55;
  filter: grayscale(0.2);
}


/* Billio app name above welcome text */
#loginModal .modal .app-name {
  font-size: 1rem;
  font-weight: 600;
  color: #111;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  font-family: 'Helvetica Neue', sans-serif;
}

#loginModal .modal-header {
  display: flex;
  align-items: center;
  gap: 0.5rem; /* space between Billio and Welcome */
}
  
#loginModal #authTitle {
  font-weight: 600;
}
  
.welcome-text {
  opacity: 0.6; /* lower opacity for the text */
  font-weight: 400; /* optional, to reduce weight */
}

.emoji {
  opacity: 1; /* keep emojis fully opaque */
}

#filterBtn {
  transition: opacity 0.2s ease;
}

/* ================= MOBILE: KEEP BILLS TABLE IDENTICAL TO DESKTOP ================= */
@media (max-width: 768px) {

  /* Optional: keep your overall page spacing if you like */
  body { padding: 1.2rem 0.7rem 6.5rem; }
  .container { width: 100%; margin: 0.6rem auto; padding: 0 0.5rem; }

  /* IMPORTANT:
     Do NOT restyle .bill*, .chip*, .icon-btn*, .bill-right*, etc.
     Leaving them alone keeps mobile identical to desktop.
  */
  .controls {
    padding-bottom: 1.1rem;
    padding-left: 1.5rem;
    padding-right: 1.5rem;
  }

  /* ===== iOS form control color override (kills blue text) ===== */
  :root { 
    -webkit-tap-highlight-color: transparent;
  }

  /* Make selects + date inputs use your text color */
  select,
  input[type="date"]{
    color: #111 !important;
    -webkit-text-fill-color: #111; /* iOS/Safari */
  }

  /* Ensure the *selected option* isn‚Äôt tinted */
  select option{
    color:#111;
  }

  /* If you‚Äôre using the pill-date style, reinforce it */
  #billsModal .pill-date{
    color:#3c3c3c !important;
    -webkit-text-fill-color:#3c3c3c;
    background: transparent;
  }

  /* Frequency select in the bills modal (if you want it gray like chips) */
  #newBillFrequency{
    color:#3c3c3c !important;
    -webkit-text-fill-color:#3c3c3c;
  }

  /* iOS Safari: prevent input zoom (must be 16px+) */
  input,
  select,
  textarea,
  button {
    font-size: 16px;
  }

  /* If you only want this for specific fields, use this instead: */
  .bill-name-input,
  #newBillAmount,
  #newBillName,
  #incomeAmount,
  #nextPayday,
  #incomeFrequency,
  #newBillFrequency,
  #newBillStart,
  .inline-editor input,
  .inline-editor select {
    font-size: 16px !important;
  }
}

</style>
</head>
<body>

<!-- DASHBOARD -->
<div class="container" id="dashboard">
  <section class="hero">
    <div class="hero-amount" id="spendingLeft">$0.00</div>
    <div class="hero-label" id="heroIncomeLabel">Spending Money Left</div>
    <div class="hero-sub" id="heroSubText">This period</div>
  </section>

  <section class="context">
    <div class="context-card">
      <div class="context-value" id="incomeValue">$0.00</div>
      <div class="context-label" id="incomeLabel">Income</div>
    </div>
    <div class="context-card">
      <div class="context-value" id="billsValue">$0.00</div>
      <div class="context-label">Total Bills</div>
    </div>
  </section>

  <section class="bills">
    <div class="bills-header" id="billsHeader" style="display:flex; justify-content:space-between; align-items:center;">
  <h2 style="margin:0;">Bill Details</h2>
  <div style="display:flex; align-items:center; gap:1.5rem;">
    <button class="toggle-btn" id="toggleBtn" onclick="toggleBills()" aria-label="Toggle bill details">
      <svg class="toggle-icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M6 9l6 6 6-6"></path>
      </svg>
    </button>
  </div>
</div>

    <div class="bill-list" id="billList"></div>
  </section>
</div>

<section class="controls">
  <button class="secondary" onclick="showModal('incomeModal')" aria-label="Income">
    <svg class="income-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <rect x="3.5" y="6.5" width="17" height="11" rx="2"/>
      <circle cx="12" cy="12" r="2.2"/>
    </svg>
  </button>
  <button class="primary" id="addBillBtn" onclick="quickAddBill()" aria-label="Add bill" style="background:#111;color:#fff;">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M12 5v14M5 12h14"/>
    </svg>
  </button>
  <button class="logout-btn" onclick="logout()" aria-label="Log out">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M9 20H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h4"/>
      <path d="M16 17l5-5-5-5"/>
      <path d="M21 12H9"/>
    </svg>
  </button>
</section>

<div class="inline-editor" id="inlineEditor" aria-hidden="true"></div>

<!-- MODALS -->
<div class="modal-overlay" id="incomeModal">
  <div class="sheet">
    <div class="sheet-header">
      <h3>Pay Schedule</h3>
      <span class="close-btn" onclick="closeModal('incomeModal')">&times;</span>
    </div>

    <div class="sheet-row">
      <span class="sheet-label">Amount</span>
      <input type="text" id="incomeAmount" inputmode="decimal" placeholder="Income Amount">
    </div>
    <div class="sheet-divider"></div>

    <div class="sheet-row">
      <span class="sheet-label">Frequency</span>
      <select id="incomeFrequency">
        <option value="" disabled selected>Frequency</option>
        <option value="once">One-time</option>
        <option value="weekly">Weekly</option>
        <option value="biweekly">Biweekly</option>
        <option value="monthly">Monthly</option>
      </select>
    </div>
    <div class="sheet-divider"></div>

    <div class="sheet-row">
      <span class="sheet-label">Next Payday</span>
      <input type="date" id="nextPayday">
    </div>

    <div id="incomeError" class="inline-error" aria-live="polite"></div>

    <button onclick="saveIncome()">Save</button>
  </div>
</div>

<div class="modal-overlay" id="billsModal">
  <div class="modal">
    <div class="modal-header"><h3>Manage Bills</h3><span class="close-btn" onclick="closeModal('billsModal')">&times;</span></div>
    <input type="text" id="newBillName" placeholder="Bill Name">
    <input type="text" id="newBillAmount" inputmode="decimal" placeholder="Amount">
    <select id="newBillFrequency">
      <option value="" disabled selected hidden>Frequency</option>
      <option value="once">Once</option>
      <option value="weekly">Weekly</option>
      <option value="biweekly">Biweekly</option>
      <option value="monthly">Monthly</option>
    </select>
    <div class="date-field">
      <label class="input-label mobile-only">Due Date</label>
      <input type="date" id="newBillStart" class="pill-date">
    </div>
    <button onclick="addBill()">Save</button>
  </div>
</div>

<div class="modal-overlay" id="filterModal">
  <div class="modal">
    <div class="modal-header">
      <h3>Filter Bills</h3>
      <span class="close-btn" onclick="closeModal('filterModal')">&times;</span>
    </div>

    <label class="input-label">Sort by</label>
    <select id="sortSelect">
      <option value="none">Closest ‚Üí Farthest</option>
      <option value="amount-desc">Highest ‚Üí Lowest</option>
      <option value="amount-asc">Lowest ‚Üí Highest</option>
    </select>

    <label class="input-label">Frequency</label>
    <select id="frequencyFilter">
      <option value="all">All</option>
      <option value="once">One-time</option>
      <option value="weekly">Weekly</option>
      <option value="biweekly">Biweekly</option>
      <option value="monthly">Monthly</option>
    </select>


    <button onclick="applyFilters()">Apply Filters</button>
    <p style="text-align:center; margin-top:0.5rem; font-size:0.75rem; color:#111; cursor:pointer;" onclick="resetFilters()">Reset</p>
  </div>
</div>

<!-- LOGIN MODAL: TOGGLE/SWITCH FORM -->
<div class="modal-overlay" id="loginModal">
  <div class="modal">
    <div class="modal-header app-header">
      <div class="app-name">Billio</div>
    </div>

    <h3 id="authTitle">
      <span class="welcome-text">Welcome</span>
    </h3>
   
    <input type="email" id="authEmail" placeholder="Email" />
    <input type="password" id="authPassword" placeholder="Password" />

    <!-- Forgot password -->
    <p id="forgotPasswordWrapper" style="text-align:center; margin-top:0.5rem; display:none; font-size:0.85rem;">
      <a href="#" class="forgot-link" id="forgotPasswordLink" onclick="forgotPassword(event)">Forgot Password?</a>
    </p>
    
    <!-- Inline error message -->
    <div id="authError" style="color:red; font-size:0.8rem; margin-top:0.25rem; display:none; text-align:center;"></div>

    <button id="authSubmitBtn" onclick="handleAuth()">Log In</button>

    <p style="text-align:center; margin-top:0.5rem;">
      <span id="authToggleText">Not registered? </span>
      <a href="#" id="authToggleLink" onclick="toggleAuthMode(event)">Register</a>
    </p>
  </div>
</div>

<!-- FIREBASE SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA0UCkq1LBiewo48_mDgFnd2zPs2BbSkfI",
  authDomain: "budget-calculator-af483.firebaseapp.com",
  projectId: "budget-calculator-af483",
  storageBucket: "budget-calculator-af483.firebasestorage.app",
  messagingSenderId: "560067714902",
  appId: "1:560067714902:web:b7801e12244f8cffb0c0f7"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let income = { amount: 0, frequency: "", nextPayday: null };
let bills = [];
let billsVisible = false;
let editBillId = null;
let expandedBillIds = new Set();
let pendingBills = [];
let inlineEditorReady = false;
let focusBillId = null;
let manualOrder = false;
let dragState = {
  active: false,
  dragEl: null,
  pointerId: null,
  longPressTimer: null,
  startX: 0,
  startY: 0,
  lastDeltaY: 0,
  dragDirection: null,
  lastDir: "down",
  items: [],
  positions: [],
  startIndex: -1,
  currentIndex: -1,
  gap: 0,
  justDragged: false,
  listenersReady: false,
  pointerDown: false,
  touchGuardRow: null
};

function guardTouchScrolling(row){
  if (!row) return;
  row.style.touchAction = "none";
  dragState.touchGuardRow = row;
}

function releaseTouchScrolling(){
  if (!dragState.touchGuardRow) return;
  dragState.touchGuardRow.style.touchAction = "";
  dragState.touchGuardRow = null;
}

let billFilters = {
  sort: "none",
  frequency: "all"
};

let userChoseSort = false;

function generateId(){
  return `bill_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
}

// ==================== LOGIN/REGISTER TOGGLE ====================
let authMode = "login"; // "login" or "register"

function toggleAuthMode(e){
  e.preventDefault();
  authMode = authMode === "login" ? "register" : "login";
  
  const title = document.getElementById("authTitle");
  const submitBtn = document.getElementById("authSubmitBtn");
  const toggleText = document.getElementById("authToggleText");
  const toggleLink = document.getElementById("authToggleLink");
  const forgotWrapper = document.getElementById("forgotPasswordWrapper");
  const authError = document.getElementById("authError");

  // Clear any previous error
  authError.style.display = "none";
  authError.textContent = "";

  if(authMode === "login"){
    const currentEmoji = title.querySelector(".emoji")?.textContent || "üëã";
    title.innerHTML = `<span class="welcome-text">Welcome Back</span> <span class="emoji">${currentEmoji}</span>`;
    submitBtn.textContent = "Log In";
    toggleText.textContent = "Not registered? ";
    toggleLink.textContent = "Register";
    forgotWrapper.style.display = "block"; // show forgot password
  } else {
    title.innerHTML = `<span class="welcome-text">Create Account</span>`;
    submitBtn.textContent = "Register";
    toggleText.textContent = "Already have an account? ";
    toggleLink.textContent = "Log In";
    forgotWrapper.style.display = "none"; // hide forgot password
  }
}

// ==================== HANDLE LOGIN / REGISTER ====================
function handleAuth() {
  const email = document.getElementById("authEmail").value.trim();
  const password = document.getElementById("authPassword").value.trim();
  const authError = document.getElementById("authError");

  authError.style.display = "none";
  authError.textContent = "";

  if (!email || !password) {
    authError.textContent = "Please enter both email and password.";
    authError.style.display = "block";
    return;
  }

  if (authMode === "login") {
    auth.signInWithEmailAndPassword(email, password)
      .then(userCredential => {
        const user = userCredential.user;
        if (!user.emailVerified) {
          auth.signOut();
          authError.textContent = "Please verify your email before logging in. Check your inbox!";
          authError.style.display = "block";
        }
      })
      .catch(err => {
        authError.textContent = err.message;
        authError.style.display = "block";
      });
  } else {
    // Registration
    auth.createUserWithEmailAndPassword(email, password)
      .then(userCredential => {
        const user = userCredential.user;
        user.sendEmailVerification()
          .then(() => {
            authError.textContent = "Verification email sent! Please check your inbox before logging in.";
            authError.style.color = "green"; // optional: green for success
            authError.style.display = "block";
            // Switch to login screen
            if (authMode !== "login") toggleAuthMode({ preventDefault: () => {} });
          })
          .catch(err => {
            authError.textContent = "Failed to send verification email: " + err.message;
            authError.style.display = "block";
          });
      })
      .catch(err => {
        authError.textContent = err.message;
        authError.style.display = "block";
      });
  }
}

// ==================== INIT ON PAGE LOAD ====================
document.addEventListener("DOMContentLoaded", () => {
  const forgotWrapper = document.getElementById("forgotPasswordWrapper");
  // Show forgot password immediately if modal defaults to login
  forgotWrapper.style.display = authMode === "login" ? "block" : "none";
});

// ==================== EXISTING DASHBOARD LOGIC ====================
function logout(){ auth.signOut(); }

auth.onAuthStateChanged(user => {
  const dashboard = document.getElementById("dashboard");
  const loginModal = document.getElementById("loginModal");
  const controls = document.querySelector(".controls"); // reference controls

  if(user){
    loginModal.style.display = "none";
    dashboard.style.display = "block";
    controls.style.display = "grid"; // show controls
    loadUserData(user.uid);
  } else {
    dashboard.style.display = "none";
    loginModal.style.display = "flex";
    controls.style.display = "none"; // hide controls when logged out
  }
});

function forgotPassword(e) {
  e.preventDefault();
  const email = document.getElementById("authEmail").value.trim();
  if (!email) return alert("Please enter your email to reset password.");

  auth.sendPasswordResetEmail(email)
    .then(() => {
      alert("Password reset email sent! Check your inbox.");
    })
    .catch(err => {
      alert(err.message);
    });
}

function saveUserData(){ db.collection("users").doc(auth.currentUser.uid).set({income, bills}); }
function loadUserData(uid){
  db.collection("users").doc(uid).onSnapshot(doc=>{
    const data = doc.data();
    if(data){
      income = data.income||income;
      const loadedBills = Array.isArray(data.bills) ? data.bills : [];
      let needsSave = false;
      bills = loadedBills
        .map(b => {
          if (!b || typeof b !== "object") return null;
          if (!b.id) {
            needsSave = true;
            return { ...b, id: generateId() };
          }
          return b;
        })
        .filter(Boolean);
      if (needsSave) saveUserData();
      recalc();
    }
  });
}

function toggleBills() {
  if (!income.nextPayday) {
    alert("Please input your income first.");
    return;
  }
  setBillsVisible(!billsVisible);
}

function setBillsVisible(visible){
  billsVisible = visible;
  document.getElementById("billList").style.display =
    billsVisible ? "block" : "none";
  const toggleBtn = document.getElementById("toggleBtn");
  if (toggleBtn) toggleBtn.classList.toggle("is-open", billsVisible);
}

function quickAddBill(){
  if (!income.nextPayday) {
    alert("Please input your income first.");
    return;
  }
  if (!billsVisible) setBillsVisible(true);
  const id = generateId();
  focusBillId = id;
  pendingBills.unshift({
    id,
    name: "",
    amount: null,
    frequency: "",
    date: "",
    placeholder: true
  });
  expandedBillIds.add(id);
  renderBills();
}

function showModal(id){
  document.getElementById(id).style.display="flex";
  if(id==="billsModal" && editBillId===null){
    document.getElementById("newBillName").value="";
    document.getElementById("newBillAmount").value="";
    document.getElementById("newBillStart").value="";
    document.getElementById("newBillFrequency").value="";
  }
  if (id === "incomeModal") {
    document.getElementById("incomeAmount").value = income.amount > 0 ? income.amount : "";
    document.getElementById("incomeFrequency").value = income.frequency || "";
    document.getElementById("nextPayday").value = income.nextPayday || "";
    const err = document.getElementById("incomeError");
    if (err) err.textContent = "";
  }
}
function closeModal(id){ if(id!=="loginModal") {document.getElementById(id).style.display="none"; editBillId=null;} }

function sanitizeAmountValue(raw){
  const cleaned = String(raw || "").replace(/[^0-9.]/g, "");
  const firstDot = cleaned.indexOf(".");
  if (firstDot === -1) return cleaned;
  return cleaned.slice(0, firstDot + 1) + cleaned.slice(firstDot + 1).replace(/\./g, "");
}

function saveIncome() {
  const amountInput = document.getElementById("incomeAmount");
  const cleanedAmount = sanitizeAmountValue(amountInput.value);
  amountInput.value = cleanedAmount;
  const amount = parseFloat(cleanedAmount);
  const frequency = document.getElementById("incomeFrequency").value;
  const nextPayday = document.getElementById("nextPayday").value;
  const err = document.getElementById("incomeError");

  if (isNaN(amount) || amount <= 0) { if (err) err.textContent = "Please enter a valid income amount."; return; }
  if (!frequency) { if (err) err.textContent = "Please select a frequency."; return; }
  if (!nextPayday) { if (err) err.textContent = "Please select your next payday."; return; }
  if (err) err.textContent = "";

  income = { amount, frequency, nextPayday };
  saveUserData();
  closeModal("incomeModal");
  recalc();
}

function addBill() {
  const name = document.getElementById("newBillName").value.trim();
  const amountInput = document.getElementById("newBillAmount");
  const cleanedAmount = sanitizeAmountValue(amountInput.value);
  amountInput.value = cleanedAmount;
  const amount = parseFloat(cleanedAmount);
  const frequency = document.getElementById("newBillFrequency").value;
  const startDate = document.getElementById("newBillStart").value;

  if (!name) { alert("Please enter a name for your bill."); return; }
  if (isNaN(amount) || amount < 0) { alert("Please enter a valid amount for the bill."); return; }
  if (!startDate) { alert("Please select a start date for the bill."); return; }

  if(editBillId!==null){
    const idx = bills.findIndex(b => b.id === editBillId);
    if (idx >= 0) bills[idx] = { ...bills[idx], name, amount, frequency, date:startDate };
    editBillId=null;
  } else {
    bills.push({ id: generateId(), name, amount, frequency, date:startDate });
  }

  saveUserData();
  closeModal("billsModal");
  recalc();
}

function updateBillFields(billId, fields){
  let target = bills.find(b => b.id === billId);
  if (!target) {
    const pendingIndex = pendingBills.findIndex(b => b.id === billId);
    if (pendingIndex === -1) return;
    let pendingBill = pendingBills[pendingIndex];
    pendingBill = { ...pendingBill, ...fields };
    pendingBills[pendingIndex] = pendingBill;
    const ready =
      (pendingBill.name && pendingBill.name.trim().length > 0) &&
      (pendingBill.frequency && String(pendingBill.frequency).trim().length > 0) &&
      (pendingBill.date && String(pendingBill.date).trim().length > 0) &&
      (pendingBill.amount !== null && pendingBill.amount !== undefined && !isNaN(Number(pendingBill.amount)) && Number(pendingBill.amount) > 0);
    if (ready) {
      pendingBill.placeholder = false;
      const newBill = { ...pendingBill };
      delete newBill.placeholder;
      bills.unshift(newBill);
      pendingBills.splice(pendingIndex, 1);
      saveUserData();
      recalc();
    } else {
      renderBills();
    }
    return;
  }
  if (!target) return;
  Object.assign(target, fields);
  saveUserData();
  recalc();
}

function parseLocalDate(iso){
  if (!iso) return null;
  const [y, m, d] = iso.split("-").map(Number);
  if (!y || !m || !d) return null;
  return new Date(y, m - 1, d); // ‚úÖ local midnight, no timezone shift
}

function formatBillDate(dateStr){
  const d = parseLocalDate(dateStr);
  if (!d || isNaN(d.getTime())) return "Date";
  return d.toLocaleDateString("en-US", { month:"short", day:"numeric" });
}


function capitalize(text){
  if (!text) return "";
  if (text === "once") return "One-time";
  return text.charAt(0).toUpperCase() + text.slice(1);
}

function initInlineEditor(){
  if (inlineEditorReady) return;
  inlineEditorReady = true;
  document.addEventListener("click", (e) => {
    const editor = document.getElementById("inlineEditor");
    if (!editor || editor.style.display !== "block") return;
    if (editor.contains(e.target)) return;
    closeInlineEditor();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeInlineEditor();
  });
}

function openInlineEditor(bill, type, anchorEl){
  initInlineEditor();
  const editor = document.getElementById("inlineEditor");
  if (!editor) return;
  editor.innerHTML = "";

  let input;
  if (type === "date") {
    input = document.createElement("input");
    input.type = "date";
    input.value = bill.date || "";
    input.addEventListener("change", async () => {
      await updateBillFields(bill.id, { date: input.value });
      closeInlineEditor();
    });
  } else if (type === "amount") {
    input = document.createElement("input");
    input.type = "text";
    input.inputMode = "decimal";
    input.value = bill.amount == null ? "" : Number(bill.amount);
    input.addEventListener("change", async () => {
      const cleaned = sanitizeAmountValue(input.value);
      input.value = cleaned;
      const value = cleaned === "" ? null : Number(cleaned);
      await updateBillFields(bill.id, { amount: isNaN(value) ? null : value });
      closeInlineEditor();
    });
  } else if (type === "frequency") {
    input = document.createElement("select");
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Frequency";
    placeholder.disabled = true;
    placeholder.selected = !bill.frequency;
    input.appendChild(placeholder);
    const currentFreq = bill.frequency || "";
    ["once", "weekly", "biweekly", "monthly"].forEach(freq => {
      const opt = document.createElement("option");
      opt.value = freq;
      opt.textContent = capitalize(freq);
      if (currentFreq === freq) opt.selected = true;
      input.appendChild(opt);
    });
    input.addEventListener("change", async () => {
      await updateBillFields(bill.id, { frequency: input.value });
      closeInlineEditor();
    });
  }

  if (!input) return;
  editor.appendChild(input);
  positionInlineEditor(editor, anchorEl);
  editor.style.display = "block";
  editor.setAttribute("aria-hidden", "false");
  setTimeout(() => {
    input.focus();
    if (input.type === "date" && typeof input.showPicker === "function") {
      input.showPicker();
    }
  }, 0);
}

function openOccurrenceDatePicker(bill, anchorEl, presetDate){
  initInlineEditor();
  const editor = document.getElementById("inlineEditor");
  if (!editor) return;
  editor.innerHTML = "";

  const input = document.createElement("input");
  input.type = "date";
  input.value = presetDate || bill.date || "";
  input.addEventListener("change", async () => {
    await updateBillFields(bill.id, { date: input.value });
    closeInlineEditor();
  });

  editor.appendChild(input);
  positionInlineEditor(editor, anchorEl);
  editor.style.display = "block";
  editor.setAttribute("aria-hidden", "false");
  setTimeout(() => input.focus(), 0);
}

function positionInlineEditor(editor, anchorEl){
  const rect = anchorEl.getBoundingClientRect();
  editor.style.left = "0px";
  editor.style.top = "0px";
  editor.style.display = "block";
  const w = editor.offsetWidth;
  const h = editor.offsetHeight;
  const left = Math.min(window.innerWidth - w - 8, Math.max(8, rect.left));
  const top = Math.min(window.innerHeight - h - 8, rect.bottom + 6);
  editor.style.left = `${left}px`;
  editor.style.top = `${top}px`;
}

function closeInlineEditor(){
  const editor = document.getElementById("inlineEditor");
  if (!editor) return;
  editor.style.display = "none";
  editor.setAttribute("aria-hidden", "true");
}

function setupDragReorder(list){
  if (!dragState.listenersReady) {
    dragState.listenersReady = true;
    document.addEventListener("pointerup", () => endDrag(list));
    document.addEventListener("pointercancel", () => endDrag(list));
  }
  const wrappers = Array.from(list.querySelectorAll(".bill-wrapper"));
  wrappers.forEach(wrapper => {
    const row = wrapper.querySelector(".bill-row");
    if (!row) return;

    row.addEventListener("pointerdown", (e) => {
      if (e.target.closest("input, select, textarea, a")) return;
      if (wrapper.dataset.pending === "true") return;
      if (e.pointerType === "mouse") e.preventDefault();
      if (e.pointerType === "touch") guardTouchScrolling(row);
      // Switch to grabbing only after reorder activates
      dragState.pointerDown = true;
      dragState.pointerId = e.pointerId;
      dragState.startX = e.clientX;
      dragState.startY = e.clientY;
      const delay = e.pointerType === "touch" ? 500 : 400;
      cancelLongPress();
      dragState.longPressTimer = setTimeout(() => {
        startDrag(wrapper, list, e);
      }, delay);
      row.setPointerCapture(e.pointerId);
    });

    row.addEventListener("pointermove", (e) => {
      if (dragState.active) {
        handleDragMove(list, e);
        return;
      }
      if (!dragState.longPressTimer) return;
      const dx = Math.abs(e.clientX - dragState.startX);
      const dy = Math.abs(e.clientY - dragState.startY);
      if (dx > 6 || dy > 6) cancelLongPress();
    });

    row.addEventListener("pointerup", () => {
      releaseTouchScrolling();
      endDrag(list);
    });
    row.addEventListener("pointercancel", () => {
      releaseTouchScrolling();
      endDrag(list);
    });
  });
}

function cancelLongPress(){
  clearTimeout(dragState.longPressTimer);
  dragState.longPressTimer = null;
  if (!dragState.active) document.body.classList.remove("drag-cursor");
  releaseTouchScrolling();
}

function startDrag(wrapper, list, e){
  if (!dragState.pointerDown) return;
  dragState.active = true;
  document.body.classList.add("drag-cursor");
  dragState.dragEl = wrapper;
  dragState.justDragged = true;
  list.classList.add("reorder-mode");
  list.classList.add("dragging");
  wrapper.classList.add("dragging");
  // Keep expanded rows open during reorder
  const group = wrapper.dataset.group || "due";
  const items = Array.from(list.querySelectorAll(".bill-wrapper"))
    .filter(el => el.dataset.pending !== "true" && (el.dataset.group || "due") === group);
  dragState.items = items;
  dragState.items.forEach(item => item.classList.add("reorder-mode"));
  dragState.startIndex = items.indexOf(wrapper);
  dragState.currentIndex = dragState.startIndex;
  dragState.positions = items.map(el => el.getBoundingClientRect());
  dragState.gap = computeGap(dragState.positions);
  const startRect = dragState.positions[dragState.startIndex];
  const firstRect = dragState.positions[0] || startRect;
  const lastRect = dragState.positions[dragState.positions.length - 1] || startRect;
  const rectHeight = startRect.height;
  const dragCenterOffset = rectHeight / 2;
  const firstMid = firstRect.top + firstRect.height / 2;
  const lastMid = lastRect.top + lastRect.height / 2;
  dragState.minDelta = firstMid - startRect.top - dragCenterOffset - 1;
  dragState.maxDelta = lastMid - startRect.top - dragCenterOffset + 1;
  const rect = wrapper.getBoundingClientRect();
  dragState.offsetY = e.clientY - rect.top;
  dragState.startY = e.clientY;
  dragState.lastEvent = null;
  dragState.lastDeltaY = 0;
  dragState.dragDirection = null;
  wrapper.style.display = "block";
  if (e && typeof e.preventDefault === "function") e.preventDefault();
}

function handleDragMove(list, e){
  if (!dragState.active || !dragState.dragEl) return;
  if (e && typeof e.preventDefault === "function") e.preventDefault();
  autoScrollOnDrag(e);
  if (dragState.positions.length === 0) return;
  const rect = dragState.positions[dragState.startIndex];
  const rawDeltaY = e.clientY - dragState.startY;
  const deltaY = Math.max(dragState.minDelta, Math.min(rawDeltaY, dragState.maxDelta));
  dragState.dragEl.style.transform = `translateY(${deltaY}px)`;
  dragState.dragEl.style.zIndex = "3";
  dragState.dragEl.style.opacity = "0.95";
  const dragCenterY = rect.top + deltaY + rect.height / 2;
  const targetIndex = getTargetIndexFromPositions(dragCenterY, dragState.positions, dragState.startIndex);
  if (targetIndex !== dragState.currentIndex) {
    dragState.items.forEach(item => item.classList.remove("reorder-target"));
    if (dragState.items[targetIndex]) dragState.items[targetIndex].classList.add("reorder-target");
    dragState.currentIndex = targetIndex;
    applyItemTransforms();
  }
  dragState.lastDeltaY = deltaY;
}

function endDrag(list){
  if (dragState.longPressTimer) cancelLongPress();
  releaseTouchScrolling();
  dragState.pointerDown = false;
  document.body.classList.remove("drag-cursor");
  if (!dragState.active) return;
  dragState.active = false;
  if (dragState.dragEl) dragState.dragEl.classList.remove("dragging");
  dragState.items.forEach(item => item.classList.remove("reorder-mode"));
  dragState.items.forEach(item => item.classList.remove("reorder-target"));
  list.classList.remove("reorder-mode");
  list.classList.remove("dragging");
  if (dragState.dragEl) {
    dragState.dragEl.style.display = "";
  }
  finalizeOrder(list);
  const orderedIds = Array.from(list.querySelectorAll(".bill-wrapper"))
    .map(el => el.dataset.billId)
    .filter(Boolean);
  const pendingMap = new Map(pendingBills.map(b => [b.id, b]));
  const billMap = new Map(bills.map(b => [b.id, b]));
  const newPending = [];
  const newBills = [];
  orderedIds.forEach(id => {
    if (pendingMap.has(id)) newPending.push(pendingMap.get(id));
    else if (billMap.has(id)) newBills.push(billMap.get(id));
  });
  if (newPending.length || newBills.length) {
    pendingBills = newPending;
    bills = newBills;
    manualOrder = true;
    billFilters.sort = "none";
    const sortSelect = document.getElementById("sortSelect");
    if (sortSelect) sortSelect.value = "none";
    saveUserData();
  }
  dragState.dragEl = null;
  dragState.items = [];
  dragState.positions = [];
  dragState.startIndex = -1;
  dragState.currentIndex = -1;
  setTimeout(() => { dragState.justDragged = false; }, 0);
  recalc();
}

function autoScrollOnDrag(e){
  const edge = 80;
  const y = e.clientY;
  const max = window.innerHeight;
  if (y < edge) window.scrollBy(0, -10);
  else if (y > max - edge) window.scrollBy(0, 10);
}

function computeGap(rects){
  const gaps = [];
  for (let i = 0; i < rects.length - 1; i++) {
    const gap = rects[i + 1].top - (rects[i].top + rects[i].height);
    if (gap > 0) gaps.push(gap);
  }
  return gaps.length ? Math.min(...gaps) : 0;
}

function getTargetIndexFromPositions(dragCenterY, rects, startIndex){
  if (!rects || rects.length === 0) return startIndex;
  const firstMid = rects[0].top + rects[0].height / 2;
  if (dragCenterY <= firstMid) return 0;
  const startRect = rects[startIndex];
  if (startRect && dragCenterY >= startRect.top && dragCenterY <= startRect.bottom) {
    return startIndex;
  }
  let target = startIndex;
  for (let i = 0; i < rects.length; i++) {
    if (i === startIndex) continue;
    const mid = rects[i].top + rects[i].height / 2;
    if (dragCenterY < mid) return i;
    if (i === rects.length - 1) target = i;
  }
  return target;
}

function applyItemTransforms(){
  const start = dragState.startIndex;
  const target = dragState.currentIndex;
  const shift = (dragState.positions[start]?.height || 0) + dragState.gap;
  dragState.items.forEach((item, i) => {
    if (i === start) return;
    let offset = 0;
    if (i > start && i <= target) offset = -shift;
    if (i < start && i >= target) offset = shift;
    item.style.transform = offset ? `translateY(${offset}px)` : "";
  });
}

function finalizeOrder(list){
  if (!dragState.dragEl) return;
  const start = dragState.startIndex;
  const dragRect = dragState.dragEl.getBoundingClientRect();
  const dragCenterY = dragRect.top + dragRect.height / 2;
  let target = getTargetIndexFromPositions(dragCenterY, dragState.positions, start);
  const items = dragState.items;
  if (target !== start) {
    const reference = items[target];
    if (reference && reference !== dragState.dragEl) {
      if (target > start) {
        const next = reference.nextElementSibling;
        list.insertBefore(dragState.dragEl, next);
      } else {
        list.insertBefore(dragState.dragEl, reference);
      }
    }
  }
  items.forEach(el => {
    el.style.transform = "";
    el.style.transition = "";
    el.style.zIndex = "";
  });
  dragState.dragEl.style.transform = "";
  dragState.dragEl.style.zIndex = "";
}

// Reorder intentionally disabled (reset to no drag logic)

function setNameInputSize(input){
  const text = input.value || input.placeholder || "";
  input.size = Math.max(text.length, 6);
}

// ==================== BILL RENDER ====================
function renderBills() {
  if (!income.nextPayday) return;

  const [yStart, mStart, dStart] = income.nextPayday.split("-");
  const periodStart = new Date(yStart, mStart - 1, dStart);

  const periodEnd = new Date(periodStart);
  if (income.frequency === "once") {
  // one-day period
  periodEnd.setDate(periodStart.getDate());
  }
  if (income.frequency === "weekly") periodEnd.setDate(periodStart.getDate() + 6);
  if (income.frequency === "biweekly") periodEnd.setDate(periodStart.getDate() + 13);
  if (income.frequency === "monthly") periodEnd.setMonth(periodStart.getMonth() + 1, 0);


  // Apply frequency filter
  let filteredBills = bills;
  if (billFilters.frequency !== "all") {
    filteredBills = bills.filter(b => b.frequency === billFilters.frequency);
  }

  // Map bills with next occurrence date
  let billsWithNextDate = filteredBills.map(b => ({
    bill: b,
    nextDate: b.date ? getNextBillDate(b, periodStart) : null,
    occurrences: getBillOccurrencesInPeriod(b, periodStart, periodEnd)
  }));

    // ‚úÖ Mobile default: Highest ‚Üí Lowest (only if user hasn't chosen a sort + hasn't manually reordered)
  const isMobile = window.matchMedia("(max-width: 768px)").matches;
  if (isMobile && !userChoseSort && !manualOrder) {
    billFilters.sort = "amount-desc";
    const sortSelect = document.getElementById("sortSelect");
    if (sortSelect) sortSelect.value = "amount-desc";
  }

  // Sort by selected option (respect manual order when no sort filter is applied)
  if (billFilters.sort !== "none") {
    billsWithNextDate.sort((a, b) => {
      const aAmt = (a.bill.amount == null || isNaN(a.bill.amount)) ? null : Number(a.bill.amount);
      const bAmt = (b.bill.amount == null || isNaN(b.bill.amount)) ? null : Number(b.bill.amount);
      const aDate = a.nextDate ? a.nextDate.getTime() : Infinity;
      const bDate = b.nextDate ? b.nextDate.getTime() : Infinity;
      if (billFilters.sort === "amount-desc") return (bAmt ?? -Infinity) - (aAmt ?? -Infinity);
      if (billFilters.sort === "amount-asc") return (aAmt ?? Infinity) - (bAmt ?? Infinity);
      if (billFilters.sort === "date-desc") return bDate - aDate; // farthest ‚Üí closest
      return aDate - bDate; // closest ‚Üí farthest
    });
  } else if (manualOrder) {
    const orderMap = new Map(bills.map((b, i) => [b.id, i]));
    billsWithNextDate.sort((a, b) => (orderMap.get(a.bill.id) ?? 0) - (orderMap.get(b.bill.id) ?? 0));
  }

  const list = document.getElementById("billList");
  list.innerHTML = "";

  const pendingForDisplay = pendingBills.map(b => ({ bill: b, nextDate: null, occurrences: [] }));
  const dueBills = billsWithNextDate.filter(b => b.occurrences.length > 0);
  const noDueBills = billsWithNextDate.filter(b => b.occurrences.length === 0);
  const billsForDisplay = [...pendingForDisplay, ...dueBills, ...noDueBills];

  const seenIds = new Set();
  const uniqueBillsForDisplay = [];
  for (const entry of billsForDisplay) {
    const billId = entry.bill?.id;
    if (!billId || seenIds.has(billId)) continue;
    seenIds.add(billId);
    uniqueBillsForDisplay.push(entry);
  }

  if (uniqueBillsForDisplay.length === 0) {
    list.innerHTML = `<div style="text-align:center;color:#888; font-size:0.9rem;">No bills yet</div>`;
    updateTotals(periodStart, periodEnd);
    return;
  }

  uniqueBillsForDisplay.forEach((bData, i) => {
    const b = bData.bill;

    const billEl = document.createElement("div");
    billEl.className = "bill-wrapper";
    billEl.dataset.billId = b.id;
    if (b.placeholder === true) billEl.dataset.pending = "true";

    const inner = document.createElement("div");
    inner.className = "bill";
    const expanded = expandedBillIds.has(b.id) || b.placeholder === true;
    const dueLabel = formatBillDate(b.date);
    const freqLabel = (b.placeholder && !b.frequency) ? "Frequency" : (b.frequency ? capitalize(b.frequency) : "Frequency");
    const isPending = b.placeholder === true;
    const occurrences = bData.occurrences || [];
    const occurrenceChips = occurrences
      .map(dt => {
        const iso = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
        return `<button class="chip chip-occurrence" data-occurrence="${iso}" data-bill="${b.id}" aria-label="Set anchor date">${dt.toLocaleDateString("en-US",{month:"short", day:"numeric"})}</button>`;
      })
      .join("");
    const hasDueInPeriod = occurrenceChips.length > 0;
    const noDueDate = !isPending && (!b.date || !hasDueInPeriod);
    if (noDueDate) billEl.classList.add("no-due");
    if (!isPending) billEl.dataset.group = noDueDate ? "nodue" : "due";
    const hasAmount = !(b.amount == null || isNaN(b.amount));
    const amountInline = hasAmount ? `$${Number(b.amount).toFixed(2)}` : "‚Äî";
    const amountLabel = hasAmount ? `$${Number(b.amount).toFixed(2)}` : "‚Äî";

    inner.innerHTML = `
      <div class="bill-row">
        <div class="bill-content">
          <input class="bill-name-input" type="text" placeholder="New Bill" aria-label="Bill name" />
          <div class="bill-details ${expanded ? "show" : ""}">
            <button class="chip chip-btn chip-rect" data-edit="frequency" data-bill="${b.id}" aria-label="Edit frequency">${freqLabel}</button>
            ${isPending
              ? `<button class="chip chip-btn" data-edit="date" data-bill="${b.id}" aria-label="Edit anchor date">${dueLabel}</button>`
              : (occurrenceChips
                  ? `<div class="occurrence-chips">${occurrenceChips}</div>`
                  : ``)}
          </div>
        </div>

        <div class="bill-right">
          ${expanded
            ? `<button class="bill-amount-btn" data-edit="amount" data-bill="${b.id}" aria-label="Edit amount">${amountLabel}</button>`
            : `<span class="bill-amount">${amountInline}</span>`}
          <div class="bill-actions ${expanded ? "show" : ""}">
            <div class="icon-row">
              <button class="icon-btn" onclick="deleteBill('${b.id}')" aria-label="Delete bill">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                  <path d="M18.364 5.636a1 1 0 0 0-1.414 0L12 10.586 7.05 5.636a1 1 0 0 0-1.414 1.414L10.586 12l-4.95 4.95a1 1 0 1 0 1.414 1.414L12 13.414l4.95 4.95a1 1 0 0 0 1.414-1.414L13.414 12l4.95-4.95a1 1 0 0 0 0-1.414z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    inner.style.opacity = hasAmount ? 1 : 0.8;
    const row = inner.querySelector(".bill-row");
    if (row) {
      row.addEventListener("click", (e) => {
        if (e.target.closest("button, input, select, textarea, a, .bill-actions, .chip-btn, .bill-name-btn")) return;
        if (dragState.justDragged) return;
        toggleBillDetails(b.id);
      });
    }
    const nameInput = inner.querySelector(".bill-name-input");
    if (nameInput) {
      nameInput.value = b.name || "";
      setNameInputSize(nameInput);
      nameInput.addEventListener("input", () => {
        setNameInputSize(nameInput);
      });
      nameInput.addEventListener("keydown", async (e) => {
        if (e.key !== "Enter") return;
        await updateBillFields(b.id, { name: nameInput.value.trim() });
        nameInput.blur();
      });
      nameInput.addEventListener("blur", async () => {
        await updateBillFields(b.id, { name: nameInput.value.trim() });
        setNameInputSize(nameInput);
      });
      if (focusBillId === b.id) {
        setTimeout(() => {
          nameInput.focus();
          nameInput.select();
        }, 0);
        focusBillId = null;
      }
    }

    const editTargets = inner.querySelectorAll("[data-edit]");
    editTargets.forEach((el) => {
      el.addEventListener("click", (e) => {
        e.stopPropagation();
        openInlineEditor(b, el.dataset.edit, el);
      });
    });
    const occurrenceTargets = inner.querySelectorAll("[data-occurrence]");
    occurrenceTargets.forEach((el) => {
      el.addEventListener("click", async (e) => {
        e.stopPropagation();
        const nextDate = el.dataset.occurrence;
        if (!nextDate) return;
        openOccurrenceDatePicker(b, el, nextDate);
      });
    });
    billEl.appendChild(inner);
    list.appendChild(billEl);

    if (i < uniqueBillsForDisplay.length - 1) {
      const divider = document.createElement("div");
      divider.className = "bill-divider";
      list.appendChild(divider);
    }
  });

  updateTotals(periodStart, periodEnd);

  initSortable(list);

}

let sortableInstance = null;

function initSortable(listEl){
  if (!listEl) return;

  // Destroy and recreate so it always matches the latest DOM
  if (sortableInstance) {
    sortableInstance.destroy();
    sortableInstance = null;
  }

  sortableInstance = new Sortable(listEl, {
    animation: 180,
    easing: "cubic-bezier(0.22, 1, 0.36, 1)",
    draggable: ".bill-wrapper",
    handle: ".bill-row",              // touch anywhere on the row
    filter: '[data-pending="true"]',  // don't drag placeholders
    preventOnFilter: false,
    delay: 300,
    delayOnTouchOnly: true,
    touchStartThreshold: 6,
    direction: "vertical",

    // Keep the divider lines from being draggable
    onMove: (evt) => {
      // disallow grabbing the divider element
      if (evt.related && evt.related.classList && evt.related.classList.contains("bill-divider")) {
        return false;
      }
      return true;
    },

    onStart: () => {
      document.body.classList.add("drag-cursor");
    },

    onEnd: () => {
      document.body.classList.remove("drag-cursor");

      // Read the new order from the DOM (only bill wrappers, ignore dividers)
      const orderedIds = Array.from(listEl.querySelectorAll(".bill-wrapper"))
        .map(el => el.dataset.billId)
        .filter(Boolean);

      const pendingMap = new Map(pendingBills.map(b => [b.id, b]));
      const billMap = new Map(bills.map(b => [b.id, b]));

      const newPending = [];
      const newBills = [];

      orderedIds.forEach(id => {
        if (pendingMap.has(id)) newPending.push(pendingMap.get(id));
        else if (billMap.has(id)) newBills.push(billMap.get(id));
      });

      pendingBills = newPending;
      bills = newBills;

      // Mark as manual order and stop auto-sorts
      manualOrder = true;
      billFilters.sort = "none";
      const sortSelect = document.getElementById("sortSelect");
      if (sortSelect) sortSelect.value = "none";

      saveUserData();
      recalc();
    }
  });
}

function toggleBillDetails(billId){
  if (expandedBillIds.has(billId)) expandedBillIds.delete(billId);
  else expandedBillIds.add(billId);
  renderBills();
}

function getBillOccurrencesInPeriod(bill, periodStart, periodEnd){
  if (!bill.date) return [];

  const [y, m, d] = bill.date.split("-");
  let current = new Date(y, m - 1, d);
  if (isNaN(current.getTime())) return [];

  // ONCE = only that exact date
  if (bill.frequency === "once") {
    return (current >= periodStart && current <= periodEnd)
      ? [new Date(current)]
      : [];
  }

  const occurrences = [];

  // MONTHLY
  if (bill.frequency === "monthly") {
    // advance month-by-month until we reach the pay period
    while (current < periodStart) {
      current = new Date(
        current.getFullYear(),
        current.getMonth() + 1,
        current.getDate()
      );
    }

    if (current >= periodStart && current <= periodEnd) {
      occurrences.push(new Date(current));
    }
  }
  // WEEKLY / BIWEEKLY (default to biweekly if missing)
  else {
    const step = { weekly: 7, biweekly: 14 }[bill.frequency] || 14;

    while (current <= periodEnd) {
      if (current >= periodStart) {
        occurrences.push(new Date(current));
      }
      current.setDate(current.getDate() + step);
    }
  }

  return occurrences;
}


// Helper: get next occurrence of a bill relative to a reference date
function getNextBillDate(bill, ref){
  if (!bill.date) return null;
  const [y,m,d] = bill.date.split("-");
  let current = new Date(y,m-1,d);
  if (isNaN(current.getTime())) return null;

  // ONCE = only the anchor date, or null if already passed
  if (bill.frequency === "once") {
    return current >= ref ? current : null;
  }

  if (bill.frequency === "monthly") {
  while (current < ref) {
    current = new Date(
      current.getFullYear(),
      current.getMonth() + 1,
      current.getDate()
    );
  }
  return current;
}

const step = { weekly: 7, biweekly: 14 }[bill.frequency] || 14;
while (current < ref) {
  current.setDate(current.getDate() + step);
}
return current;
}

// Totals calculation
function updateTotals(start,end){
  let totalBills=0;
  bills.forEach(b=>{
    if (!b.date) return;
    const amount = Number(b.amount);
    if (isNaN(amount)) return;
    const [y2,m2,d2]=b.date.split("-");
    let c=new Date(y2,m2-1,d2);
    if (isNaN(c.getTime())) return;
    let count = 0;

    // ONCE
    if (b.frequency === "once") {
      if (c >= start && c <= end) count = 1;
    }
    // MONTHLY
    else if (b.frequency === "monthly") {
      if (c >= start && c <= end) count = 1;
    }
    // WEEKLY / BIWEEKLY
    else {
      const step = { weekly: 7, biweekly: 14 }[b.frequency] || 14;
      while (c <= end) {
        if (c >= start) count++;
        c.setDate(c.getDate() + step);
      }
    }

    
    totalBills += count*amount;
  });

  const spending = income.amount-totalBills;
  document.getElementById("spendingLeft").textContent=`$${spending.toFixed(2)}`;
  document.getElementById("spendingLeft").className="hero-amount"+(spending<0?" negative":"");
  document.getElementById("incomeValue").textContent=`$${income.amount.toFixed(2)}`;
  document.getElementById("billsValue").textContent=`$${totalBills.toFixed(2)}`;
}

function editBill(billId){
  editBillId=billId;
  showModal("billsModal");
  const b=bills.find(x => x.id === billId);
  if (!b) return;
  document.getElementById("newBillName").value=b.name || "";
  document.getElementById("newBillAmount").value=b.amount ?? "";
  document.getElementById("newBillFrequency").value=b.frequency || "";
  document.getElementById("newBillStart").value=b.date || "";
}
function deleteBill(billId){
  const pendingIndex = pendingBills.findIndex(b => b.id === billId);
  if (pendingIndex !== -1) {
    pendingBills.splice(pendingIndex, 1);
    renderBills();
    return;
  }
  const idx = bills.findIndex(b => b.id === billId);
  if (idx < 0) return;
  bills.splice(idx,1);
  saveUserData();
  recalc();
}

function recalc(){ document.getElementById("heroIncomeLabel").textContent="Spending Money Left"; const heroSub = document.getElementById("heroSubText");
heroSub.textContent =
  income.frequency === "once" ? "One-time income" :
  income.frequency === "weekly" ? "This week" :
  income.frequency === "biweekly" ? "This pay period" :
  "This month";
renderBills(); }
  
// ====== WELCOME TITLE ANIMATION ======
const quirkyAnimals = [
  "ü¶Ñ‚ú®", "üêâüîÆ", "üê∏üíö", "ü¶äüî•", "ü¶©üå∏",
  "üêßüé©", "üêπüõ∑", "ü¶•üòé", "üê±üçï", "üê∞üíå",
  "ü¶îüéµ", "ü¶¶üéæ", "üê¢üí§", "üêëüé§", "ü¶Äüíé",
  "üê¨üåä", "ü¶íüéà", "üêá‚ú®", "ü¶®üß™", "üêíüé®",
  "ü¶¶üéÅ", "üêùüçØ", "ü¶òüèÄ", "üêÜ‚ö°", "ü¶âüìö",
  "ü¶úüß©", "üêãüé∑", "ü¶ûüçã", "üêäü™µ", "ü¶•üéß",
  "ü¶îüñåÔ∏è", "ü¶¶üõÅ", "üêìü•Å", "ü¶áüåô", "ü¶â‚òï",
  "üê†üåà", "üêåüçÑ", "üêøÔ∏èüí®", "ü¶ÄüèñÔ∏è", "üêµüéâ",
  "ü¶ëüõ∏", "üê∏üéà", "üêßüï∫", "üê¢üé©", "ü¶ñüî•",
  "ü¶âüé§", "üêùüéµ", "ü¶îü™ï", "üêäüéØ", "ü¶ìüç¶",
  "üêçüé©", "ü¶ûüéÅ"
];

function updateTitleRandomly() {
  const emojiEl = document.querySelector("#authTitle .emoji");
  if (!emojiEl) return; // Skip if emoji span doesn‚Äôt exist

  const randomIndex = Math.floor(Math.random() * quirkyAnimals.length);
  emojiEl.textContent = quirkyAnimals[randomIndex];
}

// Update every 3 seconds
setInterval(updateTitleRandomly, 3000);

function applyFilters() {
  billFilters.sort = document.getElementById("sortSelect").value;
  billFilters.frequency = document.getElementById("frequencyFilter").value;

  userChoseSort = true;

  closeModal("filterModal");
  recalc();
}

// Reset filters
function resetFilters() {
  // Reset filter values
  document.getElementById("sortSelect").value = "none";
  document.getElementById("frequencyFilter").value = "all";

  // Reset the billFilters object
  billFilters.sort = "none";
  billFilters.frequency = "all";

  userChoseSort = false;

  // Re-render bills
  renderBills();

  // Close the filter modal
  closeModal("filterModal");
}

// Long-press on header to open filters (Tasker-style)
const billsHeader = document.getElementById("billsHeader");
let headerLongPressTimer = null;
let headerLongPressTriggered = false;
const HEADER_LONG_PRESS_MS = 500;

function startHeaderLongPress() {
  if (!billsHeader) return;
  headerLongPressTriggered = false;
  clearTimeout(headerLongPressTimer);
  headerLongPressTimer = setTimeout(() => {
    headerLongPressTriggered = true;
    showModal("filterModal");
  }, HEADER_LONG_PRESS_MS);
}

function cancelHeaderLongPress() {
  clearTimeout(headerLongPressTimer);
  headerLongPressTimer = null;
}

if (billsHeader) {
  billsHeader.addEventListener("pointerdown", startHeaderLongPress);
  billsHeader.addEventListener("pointerup", cancelHeaderLongPress);
  billsHeader.addEventListener("pointerleave", cancelHeaderLongPress);
  billsHeader.addEventListener("pointercancel", cancelHeaderLongPress);

  billsHeader.addEventListener("click", (e) => {
    // If long-press opened the modal, prevent the click from doing anything else
    if (!headerLongPressTriggered) return;
    e.preventDefault();
    e.stopPropagation();
    headerLongPressTriggered = false;
  });
}

</script>
</body>
</html>
